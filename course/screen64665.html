<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>First Aid Quiz Results</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      /* padding: 20px; */
      background: #f9f9f9;
    }

    h1 {
      text-align: center;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: #fff;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .correct {
      color: green;
      font-weight: bold;
    }

    .incorrect {
      color: red;
      font-weight: bold;
    }

    #score {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }

    .expired-message {
      text-align: center;
      font-size: 16px;
      color: red;
      margin-top: 50px;
    }
  </style>
</head>
<body>

<h1>First Aid Quiz Results</h1>

<table>
  <thead>
    <tr>
      <th>Question</th>
      <th>Your Answer</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="resultsBody"></tbody>
</table>

<h2 id="score"></h2>
<div class="expired-message" id="expiredMessage" style="display:none;">
  ⏳ Your quiz results have expired. Please retake the quiz.
</div>

<script>
  /***********************
   * EXPIRY CONFIG
   ***********************/
  const EXPIRY_TIME = 60 * 60 * 1000; // 60 minutes
  const completedAt = localStorage.getItem("quizCompletedAt");

  if (!completedAt || (Date.now() - completedAt > EXPIRY_TIME)) {
    clearQuizData();
    document.getElementById("resultsBody").style.display = "none";
    document.getElementById("score").style.display = "none";
    document.getElementById("expiredMessage").style.display = "block";
  } else {

    /***********************
     * QUIZ DATA
     * Each question: key = localStorage key
     * correct = array of correct answers
     * multi = true if multiple options
     ***********************/
    const quizData = [
      {
        question: "What best describes a stroke?",
        key: "stroke_definition",
        correct: ["A stroke occurs when the blood supply to part of the brain is cut off"],
        multi: false
      },
      {
        question: "True or false: The signs of a stroke appear gradually, sometimes over several hours.",
        key: "stroke_signs_tf",
        correct: ["false"],
        multi: false
      },
      {
        question: "FAST assessment: What do you do when observing one side of the face dropping?",
        key: "fast_assessment",
        correct: ["Assess the lady for a stroke using the FAST technique by starting with asking her to smile to see if it is uneven or lopsided."],
        multi: false
      },
      {
        question: "You should not ask the person to stand up and start moving around if you suspect that they are having a stroke.",
        key: "stroke_dont_move_tf",
        correct: ["true"],
        multi: false
      },
      {
        question: "Final step of FAST assessment",
        key: "fast_final_step",
        correct: ["Time to call for help"],
        multi: false
      },
      {
        question: "Injured leg with object in wound: Is it correct to pull it out?",
        key: "leg_object",
        correct: ["No"],
        multi: false
      },
      {
        question: "How to stop bleeding while object remains in wound",
        key: "stop_bleeding",
        correct: ["Use clean clothing or some other material to secure the object in place whilst applying pressure to the area"],
        multi: false
      },
      {
        question: "What would you do if no object in the wound?",
        key: "no_object_wound",
        correct: ["Leave the wound open to the air to help it heal","Apply direct pressure to the area to stop the bleeding"],
        multi: true
      },
      {
        question: "How to reduce infection risk when caring for an open wound",
        key: "reduce_infection",
        correct: ["All of the above"],
        multi: false
      },
      {
        question: "Signs of shock in an adult",
        key: "shock_symptom_adult",
        correct: [
          "The person is pale and has cold skin",
          "The person is confused",
          "The person is having difficulty breathing"
        ],
        multi: true
      }
    ];

    /***********************
     * RENDER RESULTS
     ***********************/
    let score = 0;
    let answeredQuestions = 0;
    const tbody = document.getElementById("resultsBody");

    quizData.forEach(q => {
      let userAnswerRaw = localStorage.getItem(q.key);
      let userAnswer = userAnswerRaw;

      if (q.multi) {
        try {
          userAnswer = JSON.parse(userAnswerRaw || "[]");
        } catch(e) {
          userAnswer = [];
        }
      }

      let displayAnswer = "No Answer";
      let isCorrect = false;

      if (userAnswer) {
        if (q.multi) {
          displayAnswer = userAnswer.join(", ");
          // check if all selected match correct and length matches
          isCorrect = userAnswer.length === q.correct.length &&
                      userAnswer.every(val => q.correct.includes(val));
        } else {
          displayAnswer = userAnswer;
          isCorrect = q.correct.includes(userAnswer);
        }
        answeredQuestions++;
      }

      if (isCorrect) score++;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${q.question}</td>
        <td>${displayAnswer}</td>
        <td class="${userAnswer ? (isCorrect ? "correct" : "incorrect") : ""}">
          ${userAnswer ? (isCorrect ? "Correct" : "Incorrect") : "—"}
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("score").innerText =
      answeredQuestions > 0
        ? `Total Score: ${score} / ${quizData.length}`
        : "No quiz attempt found.";
  }

  /***********************
   * CLEAR FUNCTION
   ***********************/
  function clearQuizData() {
    const keys = [
      "stroke_definition",
      "stroke_signs_tf",
      "fast_assessment",
      "stroke_dont_move_tf",
      "fast_final_step",
      "leg_object",
      "stop_bleeding",
      "no_object_wound",
      "reduce_infection",
      "shock_symptom_adult",
      "quizCompletedAt"
    ];
    keys.forEach(k => localStorage.removeItem(k));
  }

</script>

</body>
</html>
